name: AI SAST Scan

on:
  pull_request:

jobs:
  ai-sast:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: AI SAST Scan with OpenAI
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const fs = require("fs");

            // ‚úÖ Fail fast if key is missing
            if (!process.env.OPENAI_API_KEY) {
              throw new Error("OPENAI_API_KEY is not set");
            }

            const code = fs.readFileSync("src/app.js", "utf8");

            const prompt = `
            Perform a Static Application Security Testing (SAST) analysis.
            Identify vulnerabilities with:
            - Vulnerability name
            - Severity (Low / Medium / High)
            - Explanation
            - Recommended remediation

            Code:
            ${code}
            `;

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0
              })
            });

            const data = await response.json();

            // üîç Debug output to identify API errors
            console.log("OpenAI raw response:", JSON.stringify(data, null, 2));

            // ‚úÖ Defensive check (FIXES your error)
            if (!data.choices || !Array.isArray(data.choices) || data.choices.length === 0) {
              throw new Error(`OpenAI API returned no choices. Response: ${JSON.stringify(data)}`);
            }

            const report = data.choices[0].message?.content || "No vulnerabilities found.";

            console.log("===== AI SAST REPORT =====");
            console.log(report);
