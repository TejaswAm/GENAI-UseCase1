name: AI Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest

    steps:
      - name: AI Issue Triage
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body || "";

            if (!process.env.OPENAI_API_KEY) {
              throw new Error("OPENAI_API_KEY is not set");
            }

            const prompt = `
            You are an AI assistant for issue triaging in a software repository.
            Given the title and description of a new GitHub issue, provide:
            - Suggested labels (bug, enhancement, documentation, question, security, etc.)
            - A short summary of the issue
            Format the output as JSON with "labels" and "summary" fields.

            Issue Title: ${issueTitle}
            Issue Body: ${issueBody}
            `;

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0
              })
            });

            const data = await response.json();
            console.log("OpenAI raw response:", JSON.stringify(data, null, 2));

            if (data.error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âš ï¸ AI Issue Triage skipped: ${data.error.message}`
              });
              return;
            }

            if (!data.choices || !data.choices.length) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "âš ï¸ AI Issue Triage did not generate any labels."
              });
              return;
            }

            let output;
            try {
              output = JSON.parse(data.choices[0].message?.content || "{}");
            } catch (e) {
              output = {};
            }

            const labels = output.labels || [];
            const summary = output.summary || "";

            // Apply labels to the issue
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }

            // Add a summary comment
            if (summary) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `### ðŸ¤– AI Issue Summary\n${summary}`
              });
            }
