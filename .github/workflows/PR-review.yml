name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai-pr-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: AI PR Review
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const fs = require("fs");

            if (!process.env.OPENAI_API_KEY) {
              throw new Error("OPENAI_API_KEY is not set");
            }

            // Read a very small snippet (first 20 lines)
            const code = fs.readFileSync("src/app.js", "utf8")
              .split("\n")
              .slice(0, 20)
              .join("\n");

            const prompt = `
            You are a senior developer reviewing a PR.
            Review the following code and provide:
            - Bugs or potential issues
            - Suggestions for improvement

            Code:
            ${code}
            `;

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.2
              })
            });

            const data = await response.json();

            console.log("OpenAI raw response:", JSON.stringify(data, null, 2));

            if (data.error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ö†Ô∏è AI PR Review skipped: ${data.error.message}`
              });
              return;
            }

            if (!data.choices || !data.choices.length) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "‚ö†Ô∏è AI PR Review did not generate any suggestions."
              });
              return;
            }

            const review = data.choices[0].message?.content || "No suggestions generated.";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### ü§ñ AI PR Review\n${review}`
            });
