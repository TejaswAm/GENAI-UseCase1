name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate PR diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }} > pr.diff

      - name: AI Review with OpenAI
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const fs = require("fs");

            if (!process.env.OPENAI_API_KEY) {
              throw new Error("OPENAI_API_KEY is not set");
            }

            const diff = fs.readFileSync("pr.diff", "utf8");

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: [
                  { role: "system", content: "You are a senior software engineer reviewing a pull request." },
                  { role: "user", content: diff }
                ],
                temperature: 0.2
              })
            });

            const data = await response.json();

            // üîç Log res
